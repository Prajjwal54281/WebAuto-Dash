<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebAutoDash API Debug</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        .result {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ccc;
            background: #f9f9f9;
        }

        .error {
            background: #ffebee;
            border-color: #f44336;
        }

        .success {
            background: #e8f5e9;
            border-color: #4caf50;
        }

        button {
            margin: 5px;
            padding: 10px 15px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <h1>WebAutoDash API Debug</h1>

    <div>
        <button onclick="testAdapters()">Test Adapters API</button>
        <button onclick="testJobs()">Test Jobs API</button>
        <button onclick="testActiveJobs()">Test Active Jobs API</button>
        <button onclick="clearResults()">Clear Results</button>
    </div>

    <div id="results"></div>

    <script>
        const API_BASE = 'http://localhost:5005/api';

        function addResult(title, data, isError = false) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${isError ? 'error' : 'success'}`;
            div.innerHTML = `
                <h3>${title}</h3>
                <pre>${JSON.stringify(data, null, 2)}</pre>
            `;
            results.appendChild(div);
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        async function testAdapters() {
            try {
                console.log('Testing adapters API...');
                const response = await fetch(`${API_BASE}/adapters`);
                const data = await response.json();
                console.log('Adapters response:', data);
                addResult('Adapters API', {
                    status: response.status,
                    count: data.adapters?.length || 0,
                    data: data
                });
            } catch (error) {
                console.error('Adapters API error:', error);
                addResult('Adapters API Error', error.message, true);
            }
        }

        async function testJobs() {
            try {
                console.log('Testing jobs API...');
                const response = await fetch(`${API_BASE}/jobs`);
                const data = await response.json();
                console.log('Jobs response:', data);
                addResult('Jobs API', {
                    status: response.status,
                    count: data.jobs?.length || 0,
                    totalPatients: calculateTotalPatients(data.jobs || []),
                    data: data
                });
            } catch (error) {
                console.error('Jobs API error:', error);
                addResult('Jobs API Error', error.message, true);
            }
        }

        async function testActiveJobs() {
            try {
                console.log('Testing active jobs API...');
                const response = await fetch(`${API_BASE}/jobs/active`);
                const data = await response.json();
                console.log('Active jobs response:', data);
                addResult('Active Jobs API', {
                    status: response.status,
                    count: Object.keys(data.active_jobs || {}).length,
                    data: data
                });
            } catch (error) {
                console.error('Active jobs API error:', error);
                addResult('Active Jobs API Error', error.message, true);
            }
        }

        function calculateTotalPatients(jobs) {
            let total = 0;
            jobs.forEach(job => {
                if (job.status === 'COMPLETED' && job.extracted_data) {
                    if (Array.isArray(job.extracted_data)) {
                        total += job.extracted_data.length;
                    } else if (job.extracted_data) {
                        total += 1;
                    }
                }
            });
            return total;
        }

        // Auto-run tests on page load
        window.onload = function () {
            console.log('Auto-running API tests...');
            setTimeout(testAdapters, 500);
            setTimeout(testJobs, 1000);
            setTimeout(testActiveJobs, 1500);
        };
    </script>
</body>

</html>